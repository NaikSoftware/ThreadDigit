# Аналіз алгоритму генерації машинної вишивки з фотографій

## Технічна специфікація

### Основні компоненти системи

1. **Стібок (Stitch)**
   - Визначається двома точками: start(x1, y1) та end(x2, y2)
   - Має довжину: distance = √((x2-x1)² + (y2-y1)²)
   - Обмеження: minLength ≤ distance ≤ maxLength
   - Напрямок: angle = atan2(y2-y1, x2-x1)

2. **Послідовність (Sequence)**
   - Масив стібків, де end[i] = start[i+1]
   - Всі стібки однакового кольору
   - Мінімізація обрізок нитки

### Ключові вимоги

1. **Обробка кольорів**
   - Квантування кольорів до заданої кількості
   - Мапування на доступні кольори ниток
   - Використання color distance metrics (CIE Lab)

2. **Аналіз текстури та напрямків**
   - Виявлення градієнтів та країв (edge detection)
   - Аналіз локальної орієнтації (structure tensor)
   - Адаптивна довжина стібків

3. **Заповнення областей**
   - Однорідні області - паралельні стібки
   - Текстуровані області - адаптивні напрямки
   - Можливість накладання для кращого покриття

4. **Оптимізація послідовностей**
   - Алгоритми пошуку шляхів (TSP-подібні)
   - З'єднання послідовностей
   - Мінімізація переходів між кольорами

## Наукові підходи та алгоритми

### 1. Обробка зображення
- **Floyd-Steinberg dithering** - для квантування кольорів з розподілом похибки
- **Bilateral filtering** - збереження країв при згладжуванні
- **Structure tensor analysis** - визначення локальної орієнтації

### 2. Техніки вишивки
- **Silk shading (Thread painting)** - плавні переходи кольорів
- **Sfumato** - м'які градієнти без чітких меж
- **Satin stitch patterns** - для заповнення областей

### 3. Оптимізаційні алгоритми
- **Voronoi diagrams** - для розподілу областей
- **Delaunay triangulation** - для адаптивної мережі
- **Graph algorithms** - для оптимізації шляхів

## Архітектура алгоритму

### Етап 1: Препроцесинг
1. Зміна розміру зображення до робочої роздільності
2. Фільтрація шуму
3. Підвищення контрасту

### Етап 2: Аналіз зображення
1. Сегментація на області схожих кольорів
2. Виявлення країв та контурів
3. Аналіз текстур та градієнтів
4. Побудова карти орієнтацій

### Етап 3: Квантування кольорів
1. Кластеризація кольорів (K-means в Lab просторі)
2. Мапування на палітру ниток
3. Floyd-Steinberg dithering для згладжування

### Етап 4: Генерація стібків
1. Створення адаптивної сітки
2. Генерація стібків для кожної області
3. Адаптація довжини та напрямку
4. Обробка накладань

### Етап 5: Оптимізація послідовностей
1. Групування стібків за кольорами
2. Пошук оптимальних шляхів
3. З'єднання послідовностей
4. Фінальна оптимізація

## Параметри алгоритму

```dart
class EmbroideryParameters {
  final double minStitchLength;     // мінімальна довжина стібка (мм)
  final double maxStitchLength;     // максимальна довжина стібка (мм)
  final int colorLimit;            // максимальна кількість кольорів
  final double density;            // щільність вишивки (0.1 - 1.0)
  final double smoothing;          // рівень згладжування (0.0 - 1.0)
  final bool enableSilkShading;   // використання silk shading
  final bool enableSfumato;       // використання sfumato
  final double overlapThreshold;  // поріг для накладання стібків
}
```

## Структури даних

```dart
class Stitch {
  final Point start;
  final Point end;
  final Color color;
  final double thickness;
}

class StitchSequence {
  final List<Stitch> stitches;
  final Color color;
  final String threadId;
}

class EmbroideryPattern {
  final List<StitchSequence> sequences;
  final Size dimensions;
  final Map<String, ThreadInfo> threads;
}
```