# Story 2.1: Core Stitch Generation Engine

## Status
Draft

## Story
**As a** user creating embroidery from photos,  
**I want** the system to generate individual stitches that follow image analysis and texture direction,  
**so that** the embroidery accurately represents my photo with proper stitch placement and orientation.

## Acceptance Criteria
1. Stitches follow computed direction fields from texture analysis
2. Stitch length adapts to image complexity and detail level
3. Angles accurately represent texture direction from structure tensor
4. Coverage is complete with minimal gaps between stitches
5. Generated stitches respect length constraints from parameters

## Tasks / Subtasks
- [ ] Task 1: Implement StitchGenerator core engine (AC: 1, 3, 5)
  - [ ] Create StitchGenerator class with direction field integration
  - [ ] Implement stitch placement based on DirectionField orientation data
  - [ ] Add angle calculation from structure tensor eigenvalues
  - [ ] Integrate EmbroideryParameters for length validation
  - [ ] Generate stitches respecting min/max length constraints
  
- [ ] Task 2: Implement adaptive stitch length calculation (AC: 2, 4)
  - [ ] Create AdaptiveLengthCalculator for detail-aware sizing
  - [ ] Analyze local image complexity using gradient magnitude
  - [ ] Generate longer stitches for uniform areas (up to maxLength)
  - [ ] Generate shorter stitches for detailed areas (down to minLength)
  - [ ] Ensure optimal coverage while minimizing stitch count
  
- [ ] Task 3: Implement region-based fill strategies (AC: 4)
  - [ ] Create FillStrategySelector for different region types
  - [ ] Implement parallel fill for uniform background areas
  - [ ] Add adaptive fill following texture directions
  - [ ] Create radial fill for circular/centered patterns
  - [ ] Implement gap detection and filling algorithms
  
- [ ] Task 4: Create stitch density and coverage control (AC: 4, 5)
  - [ ] Implement DensityController using density parameter
  - [ ] Calculate optimal stitch spacing based on density settings
  - [ ] Add overlap detection and management
  - [ ] Implement coverage validation algorithms
  - [ ] Generate coverage quality metrics
  
- [ ] Task 5: Integrate with quantized color data (Integration)
  - [ ] Connect StitchGenerator with ColorQuantizer output
  - [ ] Map quantized colors to ThreadColor catalog entries
  - [ ] Generate separate stitch sets for each color region
  - [ ] Implement color transition handling
  - [ ] Create comprehensive integration testing

## Dev Notes

### Stitch Generation Algorithm Foundation
[Source: docs/embroidery_algorithm_analysis.md + Research Analysis]

**Core Algorithm Approach:**
The stitch generation follows the research-backed approach of combining direction field analysis with adaptive density control. Key algorithmic components:

1. **Direction Field Integration**: Use structure tensor eigenvectors for stitch orientation
2. **Adaptive Length Control**: Vary stitch length based on local image complexity  
3. **Fill Strategy Selection**: Choose appropriate fill pattern based on region characteristics
4. **Density Management**: Control stitch spacing based on density parameter (0.1-1.0)

**Mathematical Foundations:**
```
Stitch Direction: θ = atan2(eigenvector_primary_y, eigenvector_primary_x)
Adaptive Length: L = lerp(minLength, maxLength, 1.0 - complexity)
Density Spacing: spacing = baseSpacing * (1.0 / density)
Coverage Quality: coverage = stitched_area / total_area
```

### Integration with Previous Stories
[Source: Stories 1.1, 1.2, 1.3 Dependencies]

**Required Data Inputs:**
- **DirectionField** (from Story 1.2): Provides texture orientation and coherence strength
- **Quantized ImageData** (from Story 1.3): Color-reduced image with thread mapping
- **EmbroideryParameters** (from Story 1.1): min/max length, density, quality settings
- **ThreadColor mapping** (from Story 1.3): Quantized colors mapped to thread catalog

**Integration Pattern:**
```dart
class StitchGenerator {
  StitchGenerator({
    required this.parameters,
    required this.colorQuantizer,
    required this.directionField,
  });
  
  List<StitchSequence> generate(
    ImageData quantizedImage,
    Map<Color, ThreadColor> colorMapping,
  ) {
    // Generate stitches for each color region
    // Apply direction field orientation
    // Respect parameter constraints
  }
}
```

### Project Structure Integration
[Source: docs/architecture/unified-project-structure.md]

**File Locations:**
- Main generator: `lib/algorithm/processors/stitch_generator.dart`
- Length calculator: `lib/algorithm/processors/adaptive_length_calculator.dart`
- Fill strategies: `lib/algorithm/techniques/fill_patterns.dart`
- Density control: `lib/algorithm/processors/density_controller.dart`
- Region analysis: `lib/algorithm/utils/region_analyzer.dart`

**Dependencies from Algorithm Module:**
- Models: Stitch, StitchSequence, DirectionField, EmbroideryParameters
- Processors: Output from image preprocessing and color quantization
- Utils: Mathematical utilities for geometry calculations

### Algorithm Implementation Strategy
[Source: docs/architecture/coding-standards.md + Research Analysis]

**Core Generation Pattern:**
```dart
class StitchGenerator {
  List<StitchSequence> generate(ImageData image, DirectionField field) {
    // 1. Segment image into color regions
    // 2. For each region: determine fill strategy
    // 3. Generate stitches following direction field
    // 4. Apply adaptive length calculation
    // 5. Validate coverage and density
    // 6. Group stitches into sequences by color
  }
}
```

**Fill Strategy Selection Logic:**
- **Uniform regions** (low texture variance): Parallel fill
- **Linear regions** (aspect ratio > 3:1): Linear fill along major axis
- **Detailed regions** (high gradient magnitude): Adaptive directional fill
- **Circular regions** (radial symmetry): Radial fill from center

### Mathematical Algorithms Required

**Adaptive Length Calculation:**
```
complexity = gradient_magnitude / max_gradient
adaptive_length = min_length + (max_length - min_length) * (1 - complexity)
final_length = clamp(adaptive_length, min_length, max_length)
```

**Density-Based Spacing:**
```
base_spacing = sqrt(stitch_area) // Approximate spacing for full coverage
actual_spacing = base_spacing / density // Apply density multiplier
stitch_offset = actual_spacing * perpendicular_vector(direction)
```

**Coverage Validation:**
```
coverage_ratio = filled_pixels / total_region_pixels
gap_detection = find_regions_with_coverage < threshold
gap_filling = generate_additional_stitches_for_gaps()
```

### Performance Optimization Requirements
[Source: docs/prd.md Technical Constraints]

**Mobile Performance Targets:**
- Generate 10,000 stitches in <15 seconds on mobile device
- Memory usage <384MB during stitch generation
- Support cancellation and progress tracking
- Optimize for battery life during long processing

**Algorithm Optimizations:**
- Use spatial data structures (quad-tree) for region organization
- Cache direction field lookups to avoid redundant calculations
- Batch stitch generation to minimize object creation overhead
- Use efficient data structures for coverage tracking

### Testing Standards
[Source: docs/architecture/testing-strategy.md]

**Test File Locations:**
- `test/algorithm/processors/stitch_generator_test.dart`
- `test/algorithm/processors/adaptive_length_calculator_test.dart`
- `test/algorithm/techniques/fill_patterns_test.dart`
- `test/algorithm/processors/density_controller_test.dart`
- `test/algorithm/integration/stitch_generation_integration_test.dart`

**Testing Requirements:**
- **Unit Tests**: Each component with >90% coverage including edge cases
- **Algorithm Tests**: Mathematical validation with synthetic test patterns
- **Performance Tests**: Stitch generation speed within mobile constraints
- **Quality Tests**: Coverage validation and visual quality assessment
- **Integration Tests**: End-to-end with direction fields and color quantization

**Test Data Requirements:**
- Synthetic direction fields with known orientations
- Simple geometric patterns for algorithm validation
- Complex photographic data for real-world testing
- Reference stitch patterns for quality comparison

### Quality Metrics and Validation

**Generated Stitch Quality Requirements:**
- **Direction Accuracy**: <15° deviation from direction field orientation
- **Length Distribution**: 80% of stitches within optimal length range
- **Coverage Completeness**: >95% area coverage with <5% gaps
- **Density Consistency**: <10% variation in stitch spacing within regions
- **Performance**: Generate patterns meeting time constraints

**Quality Validation Methods:**
```dart
class StitchQualityValidator {
  ValidationResult validate(List<StitchSequence> sequences) {
    // Check direction field alignment
    // Validate length distribution
    // Assess coverage completeness
    // Measure density consistency
  }
}
```

### Integration Points and Interfaces

**Input Interfaces:**
- Quantized ImageData with color regions
- DirectionField with orientation and coherence data
- EmbroideryParameters for constraints and quality settings
- Color-to-thread mapping from quantization stage

**Output Interfaces:**
- List<StitchSequence> organized by thread color
- StitchGeneration metadata (coverage, quality metrics)
- Progress callbacks for UI integration
- Error reporting for failed generation attempts

**Error Handling Strategy:**
- Validate input data completeness and consistency
- Handle degenerate cases (single-pixel regions, invalid directions)
- Graceful degradation under memory/performance pressure
- Clear error messages for parameter constraint violations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*