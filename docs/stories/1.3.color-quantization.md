# Story 1.3: Color Quantization and Thread Mapping

## Status
Draft

## Story
**As a** user creating embroidery patterns,  
**I want** my photo colors reduced to available thread colors with smooth transitions,  
**so that** my embroidery uses optimal thread selection while maintaining visual quality.

## Acceptance Criteria
1. Color quantization reduces to specified limit
2. Floyd-Steinberg dithering minimizes color banding
3. Thread mapping uses existing catalog system
4. CIEDE2000 provides perceptually accurate matching
5. Color transitions appear smooth in final output

## Tasks / Subtasks
- [ ] Task 1: Implement K-means color clustering (AC: 1)
  - [ ] Create KMeansColorQuantizer in LAB color space for perceptual accuracy
  - [ ] Implement configurable cluster count based on colorLimit parameter
  - [ ] Add convergence detection with maximum iteration limits
  - [ ] Optimize clustering for mobile performance constraints
  - [ ] Generate dominant color palette from clustering results
  
- [ ] Task 2: Implement Floyd-Steinberg dithering (AC: 2, 5)
  - [ ] Create FloydSteinbergDitherer for error diffusion
  - [ ] Implement 4-neighbor error distribution pattern
  - [ ] Add dithering strength parameter for artistic control
  - [ ] Optimize memory usage during dithering process
  - [ ] Generate smooth color transitions in quantized output
  
- [ ] Task 3: Enhance ColorMatcher with CIEDE2000 (AC: 3, 4)
  - [ ] Extend existing ColorMatcher with CIEDE2000 algorithm
  - [ ] Implement LAB color space conversion utilities
  - [ ] Add perceptual color distance calculation
  - [ ] Integrate with existing thread catalog system seamlessly
  - [ ] Provide fallback to RGB distance for performance if needed
  
- [ ] Task 4: Implement ColorQuantizer orchestration service (AC: 1-5)
  - [ ] Create ColorQuantizer service coordinating all components
  - [ ] Implement configurable quantization pipeline
  - [ ] Add progress tracking for long quantization operations
  - [ ] Handle edge cases (single color images, extreme limits)
  - [ ] Generate thread usage statistics and recommendations
  
- [ ] Task 5: Create comprehensive testing suite
  - [ ] Unit tests for K-means clustering with synthetic data
  - [ ] Floyd-Steinberg dithering tests with gradient images
  - [ ] CIEDE2000 color distance validation against reference implementations
  - [ ] Integration tests with real photo data and thread catalogs
  - [ ] Performance benchmarks meeting mobile constraints

## Dev Notes

### Color Science Foundation
[Source: Research Analysis - Color Distance Metrics]

**CIEDE2000 Implementation Requirements:**
The most perceptually accurate color difference formula with corrections for hue rotation, lightness, and chroma differences. Implementation must handle the complex mathematical components:

```
ΔE00 = √[(ΔL'/kLSL)² + (ΔC'/kCSC)² + (ΔH'/kHSH)² + RT(ΔC'/kCSC)(ΔH'/kHSH)]
```
Where RT accounts for hue rotation interaction between chroma and hue differences.

**LAB Color Space Conversion:**
```
L = 116 * f(Y/Yn) - 16
a = 500 * (f(X/Xn) - f(Y/Yn))  
b = 200 * (f(Y/Yn) - f(Z/Zn))
```
Where f(t) = t^(1/3) if t > (6/29)³, else (1/3)(29/6)²t + 4/29

**Floyd-Steinberg Error Diffusion Pattern:**
```
      X  7/16
3/16  5/16  1/16
```
Where X is current pixel, numbers show error distribution to neighbors.

### Integration with Existing Color System
[Source: lib/colors/service/color_matcher.dart analysis]

**Existing ColorMatcher Enhancement:**
The current ColorMatcher uses weighted RGB distance. We must extend it while maintaining backward compatibility:

```dart
extension ColorMatcherAlgorithm on ColorMatcherUtil {
  static ThreadColor findOptimalMatch(
    Color imageColor,
    List<ThreadColor> catalog, {
    ColorSpace colorSpace = ColorSpace.cieLab,
    bool enableDithering = true,
  }) {
    // Enhanced implementation with CIEDE2000
  }
}
```

**Thread Catalog Integration Points:**
- Existing catalogs: Madeira, Gunold, Isacord, etc.
- ThreadColor model with RGB values
- Percentage matching for quality assessment
- Multiple catalog searching capability

### Project Structure Integration
[Source: docs/architecture/unified-project-structure.md]

**File Locations:**
- K-means clustering: `lib/algorithm/processors/kmeans_color_quantizer.dart`
- Dithering: `lib/algorithm/processors/floyd_steinberg_ditherer.dart`
- Enhanced color matching: `lib/algorithm/utils/color_spaces.dart`
- Main service: `lib/algorithm/services/color_quantizer.dart`
- Color space utilities: `lib/algorithm/utils/color_conversion_utils.dart`

**Integration with Story Dependencies:**
- DirectionField from Story 1.1 (for region-aware quantization)
- Preprocessed ImageData from Story 1.2
- EmbroideryParameters configuration from Story 1.1

### Algorithm Implementation Approach
[Source: docs/architecture/coding-standards.md]

**K-means Clustering Pattern:**
```dart
class KMeansColorQuantizer {
  List<Color> quantize(ImageData image, int clusterCount) {
    // 1. Convert RGB to LAB color space
    // 2. Initialize cluster centers (k-means++)
    // 3. Iterate until convergence
    // 4. Return cluster centers as quantized palette
  }
}
```

**Performance Optimization:**
- Use typed arrays for pixel data manipulation
- Implement early convergence detection
- Limit iterations to prevent infinite loops
- Memory-efficient processing for large images

### Mathematical Constants and Parameters
[Source: Research Analysis + Technical Standards]

**Default Parameters:**
- **K-means iterations**: Maximum 100, convergence threshold 0.001
- **LAB conversion**: Standard illuminant D65, observer angle 2°
- **CIEDE2000 parameters**: kL=1, kC=1, kH=1 (standard weighting)
- **Dithering strength**: 0.8 (strong error diffusion)
- **Color limit range**: 2-64 colors (practical embroidery limits)

**Quality Thresholds:**
- Color match confidence: >80% for automatic selection
- Dithering effectiveness: <10% banding in smooth gradients
- Processing performance: <5 seconds for 512x512 image

### Testing Standards
[Source: docs/architecture/testing-strategy.md]

**Test File Locations:**
- `test/algorithm/processors/kmeans_color_quantizer_test.dart`
- `test/algorithm/processors/floyd_steinberg_ditherer_test.dart`
- `test/algorithm/utils/color_spaces_test.dart`
- `test/algorithm/services/color_quantizer_test.dart`
- `test/algorithm/integration/color_quantization_integration_test.dart`

**Testing Requirements:**
- **Unit Tests**: Each algorithm component with >90% coverage
- **Color Accuracy**: CIEDE2000 validation against reference datasets
- **Visual Quality**: Dithering effectiveness with gradient test images
- **Performance**: Quantization speed within mobile constraints
- **Integration**: End-to-end with existing thread catalog system

**Test Data Requirements:**
- Synthetic gradients for dithering validation
- Photos with known color distributions
- Reference CIEDE2000 calculations for validation
- Thread catalog samples for mapping accuracy

### Technical Integration Requirements

**Input Interface:**
- Accept preprocessed ImageData from Story 1.2
- Use EmbroideryParameters for color limits and quality settings
- Support various image formats and sizes

**Output Interface:**
- Generate quantized ImageData with reduced color palette
- Provide thread color mapping to existing ThreadColor models
- Export color statistics and quality metrics
- Create dithering maps for texture analysis integration

**Error Handling:**
- Validate color limit parameters (minimum 2, maximum 64)
- Handle edge cases (monochrome images, transparent pixels)
- Graceful degradation under memory pressure
- Clear error messages for invalid thread catalog data

### Performance Specifications
[Source: docs/prd.md Technical Constraints]

- **Processing Time**: <10 seconds for 1024x1024 image quantization
- **Memory Usage**: <256MB peak during color clustering  
- **Color Accuracy**: >90% thread matches within CIEDE2000 ΔE < 3.0
- **Visual Quality**: <5% visible banding in gradient areas after dithering

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*